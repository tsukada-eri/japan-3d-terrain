# 日本3D地形図モデル作成キット

国土地理院の基盤地図情報DEMデータから、3Dプリント用STLファイルを生成するためのツールキットです。QGISなどのGISソフトウェアを使わずに、Pythonスクリプト1本で変換できます。

---

## 全体の流れ

```
1. DEMデータをダウンロード（国土地理院）
2. 行政境界データをダウンロード（国土数値情報）
3. Pythonスクリプトで変換
4. スライサーソフトで読み込み → 3Dプリント
```

---

## STEP 1: DEMデータのダウンロード

### 1-1. 基盤地図情報ダウンロードサービスにアクセス

https://fgd.gsi.go.jp/download/menu.php

ログインが必要です（無料登録）。

### 1-2. 「基盤地図情報 数値標高モデル」を選択

「ファイル選択へ」→ 地図上で対象エリアを選択 → ダウンロード。

### 1-3. DEMデータの種類

| 種類 | 解像度 | グリッドサイズ | 説明 |
|------|--------|------------|------|
| DEM5A | 5m | 150×225 | 航空レーザ測量（最高精度） |
| DEM5B | 5m | 150×225 | 写真測量 |
| DEM5C | 5m | 150×225 | 写真測量（その他） |
| DEM10B | 10m | 750×1125 | 10mメッシュ（広域カバー） |

**推奨: 全種類をダウンロード**してください。5mデータがない地域は10mデータで自動補完されます。

### 1-4. 必要なメッシュ番号の特定

対象地域がどのメッシュに含まれるか確認します。メッシュ番号は4桁（1次メッシュ）で、例えば糸魚川市は `5537` と `5538` にまたがります。

対象地域が複数のメッシュにまたがる場合は、全メッシュ分をダウンロードしてください。不要な範囲のタイルは自動でスキップされます。

### 1-5. ダウンロードしたZIPの展開

ダウンロードしたZIPファイルはそのまま使えます（スクリプトが自動展開します）。または事前に1つのフォルダに全XMLを展開しておくとより確実です。

```bash
# 例: 全ZIPを1フォルダにまとめて展開
mkdir dem_data
cd dem_data
for f in ~/Downloads/FG-GML-*.zip; do unzip -o "$f"; done
```

---

## STEP 2: 行政境界データのダウンロード（市区町村の形で切り抜く場合）

### 2-1. 国土数値情報からGeoJSONを取得

https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N03-2023.html

「行政区域データ」の該当する都道府県のGeoJSONをダウンロードします。

ファイル名の例: `N03-23_15_230101.geojson`（新潟県の場合）

### 2-2. GeoJSONの構造

このGeoJSONには都道府県内の全市区町村のポリゴンが含まれています。スクリプトは `-n` オプションで指定した名前でフィルタリングします。

**注意:** 検索は部分一致です。`-n 糸魚川` と指定すれば「糸魚川市」にマッチします。

---

## STEP 3: STLへの変換

### 3-1. 動作要件

- Python 3.8以上
- NumPy（`pip install numpy`）
- その他の依存パッケージなし

### 3-2. 基本的な使い方

```bash
# 市区町村の形で切り抜き（余白なし）
python fgd_dem_to_stl.py ./dem_data \
  -g N03-23_15_230101.geojson \
  -n 糸魚川 \
  -o itoigawa.stl

# 四角い台座付きバージョン
python fgd_dem_to_stl.py ./dem_data \
  -g N03-23_15_230101.geojson \
  -n 糸魚川 \
  --rect \
  -o itoigawa_rect.stl

# 行政境界なしで全データを四角いSTLに
python fgd_dem_to_stl.py ./dem_data -o terrain.stl
```

### 3-3. オプション一覧

| オプション | 説明 | デフォルト |
|-----------|------|----------|
| `input` | DEMデータのフォルダまたはZIP（必須） | - |
| `-g`, `--geojson` | 行政境界GeoJSON | なし |
| `-n`, `--name` | 切り抜く地域名（部分一致） | なし |
| `-o`, `--output` | 出力STLファイル名 | `terrain.stl` |
| `-w`, `--width` | モデルの横幅(mm) | `160.0` |
| `-z`, `--z-exaggeration` | 標高の誇張倍率 | `2.0` |
| `-b`, `--base-height` | 底面の厚さ(mm) | `3.0` |
| `--max-points` | グリッド最大ポイント数 | `2500000` |
| `--rect` | 四角い台座付きモードで出力 | off |

### 3-4. パラメータ調整のガイド

**モデル幅 (`-w`)**
3Dプリンターのビルドプレートに合わせて設定します。Bambu A1 miniなら180mm以下。

**標高誇張 (`-z`)**
- `1.0`: 実際のスケール通り（平地はほぼ平ら）
- `2.0`: 推奨。地形の凹凸がわかりやすい
- `3.0`以上: ドラマチックだが非現実的

**解像度 (`--max-points`)**
- `2500000`（250万）: 標準。ファイルサイズ200MB前後
- `5000000`（500万）: 高品質。境界のガタガタが目立ちにくい
- `10000000`（1000万）: 最高品質。ファイルサイズ500MB超

---

## STEP 4: 3Dプリント

### 4-1. スライサーで読み込み

Bambu Studio、PrusaSlicer、Cura等でSTLを読み込みます。

### 4-2. よくある問題と対処

**「ファイルにジオメトリデータが含まれていません」エラー**
→ STLヘッダーが正しくない可能性。スクリプトのバグでないか確認。

**モデルが大きすぎる/小さすぎる**
→ `-w` オプションでモデル幅を調整。

**地形が平らに見える**
→ `-z` オプションで標高誇張を増やす（3.0や4.0を試す）。

**一部に段差（崖）がある**
→ DEM5AとDEM10Bの混在地域で発生する可能性。最新版スクリプトではバイリニアリサンプルで自動修正済み。

**境界線がガタガタする**
→ `--max-points` を増やして解像度を上げる。

---

## 技術的な詳細

### DEMデータの構造

基盤地図情報のDEM XMLファイルは以下の構造です:

```xml
<DEM>
  <mesh>55370000</mesh>           <!-- メッシュコード -->
  <coverage>
    <boundedBy>
      <Envelope>
        <lowerCorner>36.666... 137.000...</lowerCorner>
        <upperCorner>36.708... 137.062...</upperCorner>
      </Envelope>
    </boundedBy>
    <gridDomain>
      <Grid>
        <high>224 149</high>      <!-- (ncols-1) (nrows-1) -->
      </Grid>
    </gridDomain>
    <rangeSet>
      <DataBlock>
        <tupleList>
          地表面,12.34              <!-- タイプ,標高(m) -->
          地表面,12.56
          データなし,-9999.0        <!-- 欠損値 -->
          ...
        </tupleList>
      </DataBlock>
    </rangeSet>
  </coverage>
</DEM>
```

### メッシュコード体系

- **1次メッシュ**: 4桁（例: `5537`）。緯度40分×経度1度の範囲
- **2次メッシュ**: 6桁（例: `553700`）。1次メッシュを8×8分割
- **3次メッシュ**: 8桁（例: `55370000`）。2次メッシュをさらに10×10分割

2次メッシュコード `XXYY` のXXは1次メッシュ内の列位置（0-7, 西→東）、YYは行位置（0-7, 南→北）を示します。

### 5mメッシュと10mメッシュの統合

5mメッシュ（DEM5A/B/C）と10mメッシュ（DEM10B）はグリッドサイズが異なります:

- DEM5A: 150行 × 225列（3次メッシュあたり）
- DEM10B: 750行 × 1125列（2次メッシュあたり、5倍の範囲をカバー）

本スクリプトでは、出力グリッドの解像度を5mメッシュ基準で計算し、10mメッシュタイルはバイリニア補間で正しいサイズにリサンプルしてから配置します。これにより、解像度の異なるタイルの継ぎ目で段差（崖アーティファクト）が発生しません。

---

## ライセンス・利用規約

- **基盤地図情報**: 国土地理院の利用規約に従ってください
- **国土数値情報**: 国土交通省の利用規約に従ってください
- **本スクリプト**: 自由に利用・改変・再配布できます
